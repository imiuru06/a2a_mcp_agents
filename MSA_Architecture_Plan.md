# A2A와 MCP 프로토콜 기반 자동차 정비 서비스의 MSA 구현 계획

## 현재 시스템 분석

현재 시스템은 다음과 같은 주요 컴포넌트로 구성되어 있습니다:

1. **A2A 프로토콜 구현**: 에이전트 간 협업을 위한 프로토콜 구현
2. **MCP 프로토콜 구현**: AI 모델과 외부 도구 및 데이터 소스 간의 통합 프로토콜 구현
3. **에이전트 구현**: ShopManager, Mechanic, PartsSupplier 등의 도메인별 에이전트
4. **API 서비스**: FastAPI 기반 RESTful API 서비스
5. **웹 인터페이스**: Streamlit을 사용한 프론트엔드

## MSA 아키텍처 설계

### 1. 경계(Gateway) 계층

#### 1.1 Event Gateway
- **목적**: 모니터링 시스템의 이벤트를 수신하여 Sub-Agent로 전달
- **주요 기능**:
  - 외부 모니터링 시스템의 이벤트 수신
  - 이벤트 필터링 및 변환
  - 적절한 Sub-Agent로 이벤트 라우팅
  - 이벤트 처리 상태 추적
- **기술 스택**:
  - FastAPI
  - Redis/Kafka (이벤트 스트리밍)
  - OpenTelemetry (모니터링)

#### 1.2 Chat Gateway
- **목적**: 사용자 채팅/인터럽트/상태 메시지 처리 및 라우팅
- **주요 기능**:
  - WebSocket 연결 관리
  - 사용자 메시지 수신 및 변환
  - 메시지를 적절한 Sub-Agent 또는 Supervisor로 라우팅
  - 실시간 상태 업데이트 채널 관리
- **기술 스택**:
  - FastAPI (WebSocket 지원)
  - Redis PubSub
  - JWT 인증

### 2. 애플리케이션 계층

#### 2.1 Sub-Agent
- **목적**: 이벤트 판단, LLM 연동, MCP 도구 호출, A2A 보고
- **세부 Sub-Agent 구성**:
  - **ShopManagerAgent**: 고객 요청 처리, 진단, 작업 할당
  - **MechanicAgent**: 차량 진단, 수리 수행
  - **PartsSupplierAgent**: 부품 재고 관리, 주문 처리
- **주요 기능**:
  - 도메인별 이벤트 및 요청 처리
  - LLM을 통한 의사결정
  - MCP 프로토콜을 통한 외부 도구 호출
  - A2A 프로토콜을 통한 다른 에이전트와 협업
  - 작업 상태 및 결과 보고
- **기술 스택**:
  - FastAPI
  - LangChain/LlamaIndex (LLM 통합)
  - 도메인별 데이터베이스 (PostgreSQL)

#### 2.2 Supervisor
- **목적**: A2A 보고 수집, 상태 집계, 추가 의사결정, 사용자 응답
- **주요 기능**:
  - Sub-Agent 활동 모니터링
  - 작업 진행 상황 집계
  - 복잡한 의사 결정 및 조율
  - 사용자 응답 생성 및 관리
  - 에스컬레이션 처리
- **기술 스택**:
  - FastAPI
  - PostgreSQL (상태 저장)
  - Redis (캐싱)
  - LLM 기반 의사결정

### 3. 플랫폼 계층

#### 3.1 MCP Server
- **목적**: 도구 실행 프록시, 컨텍스트 관리, 취소 기능
- **주요 기능**:
  - MCP 도구 호출 관리 및 실행
  - 컨텍스트 및 상태 관리
  - 병렬 도구 실행 지원
  - 도구 실행 취소 및 타임아웃 관리
- **기술 스택**:
  - FastAPI
  - Redis (상태 관리)
  - 비동기 작업 큐 (Celery/RQ)

#### 3.2 Tool Registry
- **목적**: 도구 메타데이터 관리, 컨테이너 이미지 관리
- **주요 기능**:
  - 도구 등록 및 메타데이터 관리
  - 버전 관리
  - 접근 제어
  - 도구 실행 환경 및 컨테이너 관리
- **기술 스택**:
  - FastAPI
  - PostgreSQL (메타데이터 저장)
  - Docker/Kubernetes (컨테이너 관리)

### 4. 옵셔널 계층

#### 4.1 Observability
- **목적**: 분산 추적, 로깅, 메트릭, 알림
- **주요 기능**:
  - 분산 트레이싱
  - 중앙 집중식 로깅
  - 시스템 및 비즈니스 메트릭 수집
  - 이상 감지 및 알림
- **기술 스택**:
  - OpenTelemetry
  - Prometheus
  - Grafana
  - ELK Stack

## 데이터 흐름 및 통신 모델

### 동기 통신
- REST API: 서비스 간 직접 요청/응답 패턴
- gRPC: 고성능이 필요한 내부 서비스 통신

### 비동기 통신
- 이벤트 기반 통신: Kafka/RabbitMQ를 사용한 이벤트 발행/구독
- 메시지 큐: 작업 처리 및 부하 분산

### 상태 관리
- 분산 캐시: Redis를 사용한 공유 상태 및 임시 데이터 관리
- 데이터베이스: 영구 상태 저장 및 트랜잭션 관리

## 서비스 간 상호작용 시나리오

### 시나리오 1: 모니터링 트리거에 의한 자동 대응
1. **Event Gateway**가 외부 모니터링 시스템에서 이벤트 수신
2. 이벤트 유형에 따라 적절한 **Sub-Agent**로 라우팅
3. **Sub-Agent**가 이벤트 처리 및 MCP를 통한 도구 호출
4. 처리 상태 및 결과를 **Supervisor**에게 보고
5. **Supervisor**가 전체 상황을 평가하고 사용자에게 알림

### 시나리오 2: 사용자 채팅/인터럽트를 통한 에이전트 상호작용
1. **Chat Gateway**가 사용자 메시지 수신
2. 메시지 유형 및 컨텍스트에 따라 **Supervisor** 또는 특정 **Sub-Agent**로 라우팅
3. **Sub-Agent** 또는 **Supervisor**가 응답 생성
4. **Chat Gateway**를 통해 사용자에게 응답 전송

## 기술적 고려사항

### 확장성
- 수평적 확장 설계
- 스테이트리스 서비스 지향
- 자동 스케일링 구성

### 신뢰성
- 서비스 디스커버리 및 로드 밸런싱
- 회로 차단기 패턴 적용
- 재시도 및 백오프 전략
- 분산 트랜잭션 관리

### 보안
- API 게이트웨이 수준의 인증/인가
- 서비스 간 mTLS 통신
- 보안 비밀 관리
- 정기적인 보안 감사

### 개발자 경험
- 일관된 API 설계
- 자체 문서화 API
- 로컬 개발 환경 구성
- 테스트 자동화

## 필요한 인프라 자원

### 컴퓨팅 자원
- Kubernetes 노드 (최소 3개 이상)
- 개발/테스트/프로덕션 환경 분리

### 데이터 저장소
- PostgreSQL 클러스터
- Redis 클러스터
- 객체 저장소 (S3 호환)

### 메시징 시스템
- Kafka 클러스터 (또는 관리형 서비스)
- RabbitMQ (경량 메시징용)

### 모니터링 및 로깅
- Prometheus/Grafana 스택
- ELK 스택 또는 관리형 로깅 서비스 