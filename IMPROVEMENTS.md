# A2A MCP 에이전트 시스템 개선 사항

## 1. 해결된 Docker Compose 오류

Docker Compose 파일에서 `a2a-network` 네트워크 키가 두 번 정의되었던 문제를 수정했습니다. 이로 인해 발생했던 "yaml: unmarshal errors: line 329: mapping key 'a2a-network' already defined at line 327" 오류가 해결되었습니다.

## 2. Dockerfile 참조 방식 통일

서비스별로 다양하게 사용하던 Dockerfile 참조 방식을 `Dockerfile.XX` 형태로 일관되게 통일했습니다. 이전에는 일부 서비스에서는 디렉토리만 지정하고 다른 서비스에서는 명시적으로 Dockerfile을 지정하는 방식이 혼재되어 있었습니다. 모든 서비스에서 동일한 형식으로 Dockerfile을 참조하도록 하여 일관성을 확보했습니다.

특히, 누락되었던 `Dockerfile.frontend` 파일을 생성하여 프론트엔드 서비스가 정상적으로 빌드될 수 있도록 했습니다.

## 3. API Gateway HTTP 클라이언트 문제 해결

API Gateway 서비스에서 싱글톤 HTTP 클라이언트를 사용하던 방식을 수정했습니다. 이전에는 "Cannot reopen a client instance, once it has been closed" 오류가 발생했습니다. 

- 전역 HTTP 클라이언트 객체를 제거했습니다.
- 각 함수에서 컨텍스트 매니저(`async with httpx.AsyncClient() as client`)를 사용하여 HTTP 클라이언트를 생성하고 사용하도록 변경했습니다.
- 환경 변수를 통해 설정 가능한 타임아웃 값을 사용하도록 했습니다.

## 4. 프론트엔드 UI 및 기능 개선

### 4.1 Message.update() 함수 호출 방식 변경

프론트엔드에서 `Message.update(content="...")` 호출 시 "Message.update() got an unexpected keyword argument 'content'" 오류가 발생하는 문제를 해결했습니다. Chainlit의 최신 버전에서 API가 변경되어 발생한 문제였습니다.

- `processing_msg.update(content="...")` 호출 방식을 변경했습니다.
- 메시지를 업데이트하는 대신 기존 메시지를 제거하고 새로운 메시지를 생성하는 방식으로 수정했습니다.

### 4.2 Plotly 차트 오류 수정

"figure must be a plotly.graph_objects.Figure" 오류가 발생하는 문제를 해결했습니다. Chainlit의 `cl.Plotly` 컴포넌트가 딕셔너리 대신 Plotly 그래프 객체를 요구하고 있었습니다.

- `plotly.graph_objects`를 직접 임포트하여 `go.Figure` 객체를 생성하도록 수정했습니다.
- 오류 처리를 추가하여 Plotly 차트 생성에 실패할 경우에도 텍스트 내용은 표시될 수 있도록 했습니다.

### 4.3 한국어 번역 파일 추가

"Translation file for ko not found. Using default translation en-US." 오류를 해결했습니다.

- 한국어 번역 파일을 `Dockerfile.frontend`에 직접 추가했습니다.
- Chainlit 설정 파일(`.chainlit/config.toml`)을 생성하여 기본 언어 설정 및 UI 설정을 추가했습니다.

## 5. 시스템 안정성 및 성능 개선

- 프론트엔드의 `MAX_RETRIES` 값을 3에서 5로 증가시켰습니다.
- `RETRY_DELAY` 값을 1.0초에서 2.0초로 증가시켰습니다.
- `PYTHONUNBUFFERED=1` 환경 변수를 설정하여 로그 출력이 즉시 표시되도록 했습니다.
- 타임아웃 및 오류 처리 로직을 강화했습니다.

## 6. 포트 매핑 업데이트

외부 포트 충돌을 방지하기 위해 모든 서비스의 포트 매핑을 48000번대로 통일했습니다. 내부 통신은 기존 포트를 유지하여 서비스 간 호환성을 유지했습니다.

이러한 개선을 통해 시스템이 더 안정적으로 작동하고, 사용자 인터페이스가 한국어를 포함한 다양한 언어로 제공될 수 있게 되었습니다.

## 7. 서비스 간 통신 개선

### 7.1 수퍼바이저 응답 검색 로직 개선
- `supervisor` 서비스에서 클라이언트 응답 검색 로직을 개선했습니다.
- 여러 데이터 구조(클라이언트 ID 키, 리스트 내 객체)에서 응답을 검색할 수 있도록 했습니다.
- 타임스탬프 기반 정렬로 최신 응답을 항상 정확히 찾을 수 있게 했습니다.

### 7.2 채팅 게이트웨이 메시지 처리 개선
- `chat_gateway` 서비스의 메시지 저장 및 전달 로직을 개선했습니다.
- 타임아웃과 오류 처리를 명시적으로 추가했습니다.
- 환경 변수를 통한 설정 값 조정이 가능하도록 했습니다.

### 7.3 API 게이트웨이 HTTP 클라이언트 사용 개선
- 싱글톤 HTTP 클라이언트 대신 컨텍스트 매니저 방식으로 변경했습니다.
- 타임아웃 및 요청 관련 설정을 환경 변수로 외부화했습니다.
- 타임아웃 예외 처리를 추가했습니다.

### 7.4 프론트엔드 응답 처리 개선
- 슈퍼바이저 응답 대기 및 폴링 로직을 강화했습니다.
- 연속된 빈 응답 처리 로직을 추가하여 불필요한 대기 시간을 줄였습니다.
- 사용자 경험 향상을 위해 응답 스트리밍 기능을 개선했습니다.

### 7.5 MCP 서버 서비스 검색 개선
- 서비스 레지스트리 연결 로직을 강화했습니다.
- 폴백 URL 시스템을 구현하여 서비스 레지스트리가 응답하지 않을 때도 작동할 수 있게 했습니다.
- 환경 변수를 통한 재시도 및 타임아웃 설정이 가능하도록 했습니다.

## 8. 서비스 구성 개선

### 8.1 LLM 레지스트리 서비스 추가
- Docker Compose 파일에 누락되었던 `llm-registry` 서비스를 추가했습니다.
- 포트 설정, 환경 변수, 의존성 등을 적절히 구성했습니다.
- MCP 서버와의 통합을 위한 설정을 강화했습니다.

### 8.2 환경 변수 표준화
- 모든 서비스에서 사용되는 환경 변수를 표준화했습니다.
- 재시도, 타임아웃, 캐시 등의 설정을 환경 변수로 외부화했습니다.
- 기본값을 제공하여 필요한 경우 쉽게 재정의할 수 있게 했습니다.

## 9. 향후 개선 제안

1. **도커 이미지 최적화**: 각 서비스의 Dockerfile을 검토하여 불필요한 패키지 설치나 빌드 단계를 제거하면 빌드 시간과 이미지 크기를 줄일 수 있습니다.

2. **서비스 재시작 정책 추가**: Docker Compose에 `restart: unless-stopped` 또는 `restart: on-failure` 정책을 추가하여 서비스 복원력을 높일 수 있습니다.

3. **로깅 통합**: 모든 서비스에서 일관된 로깅 형식과 레벨을 사용하고, ELK 스택이나 다른 로그 수집기를 통합하는 것이 좋습니다.

4. **보안 강화**: API 키나 비밀번호와 같은 민감한 정보는 환경 변수 대신 Docker Secrets이나 Kubernetes Secrets로 관리하는 것이 좋습니다.

5. **헬스체크 개선**: 더 정교한 헬스체크 로직을 개발하여 서비스 상태를 더 정확하게 모니터링할 수 있습니다.

6. **API 문서화**: Swagger/OpenAPI를 더 활용하여 API 문서를 자동으로 생성하고 유지 관리할 수 있습니다.

7. **테스트 자동화**: 통합 테스트와 유닛 테스트를 추가하여 코드 품질을 향상시키고 회귀를 방지할 수 있습니다. 